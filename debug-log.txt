debug log:

[root@Fiscalismia-Demo ~]# podman ps
CONTAINER ID  IMAGE                                                 COMMAND               CREATED         STATUS                   PORTS                           NAMES
6f59cb2b77f9  docker.io/library/fiscalismia-postgres:1.0.0          -p 5432               22 minutes ago  Up 17 seconds (healthy)  5432/tcp                        fiscalismia-postgres
4743724fa4ed  ghcr.io/fiscalismia/fiscalismia-frontend-demo:latest  nginx -g daemon o...  2 minutes ago   Up 17 seconds            0.0.0.0:443->443/tcp, 8080/tcp  fiscalismia-frontend
[root@Fiscalismia-Demo ~]# podman exec -it fiscalismia-frontend sh
/etc/nginx $ netstat -ltnp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      1/nginx: master pro
/etc/nginx $ 

[root@Fiscalismia-Demo ~]# nft list ruleset
table ip lockdown_private_instances {
	chain input {
		type filter hook input priority filter; policy drop;
		iif "lo" accept
		ct state established,related accept
		ip saddr 172.20.1.2 tcp dport 22 ct state new accept
		ip saddr 172.20.1.3 tcp dport { 80, 443, 8443 } ct state new accept
		ip saddr 172.20.1.3 icmp type echo-request accept
	}

	chain output {
		type filter hook output priority filter; policy drop;
		oif "lo" accept
		ct state established,related accept
		ip daddr { 8.8.8.8, 185.12.64.1, 185.12.64.2 } udp dport 53 ct state new accept
		icmp type echo-request accept
		tcp dport { 80, 443 } ct state new accept
	}

	chain forward {
		type filter hook forward priority filter; policy drop;
	}
}



loadbalancer ingress remote:
[root@Fiscalismia-LoadBalancer ~]# curl -k 172.20.0.2:443 -v
*   Trying 172.20.0.2:443...
Timeout

[root@Fiscalismia-LoadBalancer ~]# nc -v4z 172.20.0.2 443
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: TIMEOUT


But when I switch to network_mode:host it works, see the debug log:
[root@Fiscalismia-Demo ~]# podman ps
CONTAINER ID  IMAGE                                                 COMMAND               CREATED         STATUS                   PORTS              NAMES
6f59cb2b77f9  docker.io/library/fiscalismia-postgres:1.0.0          -p 5432               28 minutes ago  Up 4 seconds (starting)  5432/tcp           fiscalismia-postgres
90f877aa4d63  ghcr.io/fiscalismia/fiscalismia-frontend-demo:latest  nginx -g daemon o...  4 seconds ago   Up 4 seconds             443/tcp, 8080/tcp  fiscalismia-frontend
[root@Fiscalismia-Demo ~]# podman exec -it fiscalismia-frontend sh
/etc/nginx $ netstat -ltnp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      1/nginx: master pro
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.54:53           0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:5355            0.0.0.0:*               LISTEN      -
tcp        0      0 10.89.1.1:53            0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -
tcp        0      0 :::22                   :::*                    LISTEN      -
tcp        0      0 :::5355                 :::*                    LISTEN      -
/etc/nginx $ 

[root@Fiscalismia-LoadBalancer ~]# nc -v4z 172.20.0.2 443
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Connected to 172.20.0.2:443.
Ncat: 0 bytes sent, 0 bytes received in 0.03 seconds.


[root@Fiscalismia-LoadBalancer ~]# curl -k 172.20.0.2:443 -v
*   Trying 172.20.0.2:443...
* Connected to 172.20.0.2 (172.20.0.2) port 443
* using HTTP/1.x
> GET / HTTP/1.1
> Host: 172.20.0.2:443
> User-Agent: curl/8.11.1
> Accept: */*
>
* Request completely sent off
* Recv failure: Connection reset by peer
* closing connection #0
curl: (56) Recv failure: Connection reset by peer

######################################
######################################
######################################
######################################
######################################

## Solution: Allow Podman Bridge Traffic in nftables

You need to allow forwarding for the Podman network interface while keeping your security posture tight.

### Step 1: Find Podman Network Interface Name

```bash
# On the demo instance
podman network inspect fiscalismia-network | grep -i bridge
# Or
ip link show | grep -E "podman|cni"
```

Podman typically creates interfaces like `podman0`, `podman1`, or `cni-podman0`.

### Step 2: Update nftables Script

````bash
#!/usr/bin/env bash

################################ INFO ########################################################################################
# This file is intended for private instances without a public ip assigned, to which hcloud does not allow attaching firewalls
# We manually install and configure nftables, the best practice tools for firewall rules used as backend for other frameworks
# PARAM $1 is the loadbalancer private ipv4 for https ingress allowance
# PARAM $2 is the bastion-host private ipv4 for ssh ingress allowance
# PARAM $3 is the nat-gateway private ipv4 for https and http egress allowance
# PARAM $4 is the virtual network gateway used as the next-hop target for private egress to NAT-Gateway
# PARAM $5 OPTIONAL Parameter to allow an additional port for ingress on the demo instance running frontend + backend
# e.g. ./scripts/nftables_lockdown_private_instances.sh 172.20.1.3 172.20.1.2 172.20.1.4 172.20.0.1
##############################################################################################################################

# wait for the private network interface to initialize.
sleep 60

export LOADBALANCER_PRIVATE_IP="$1"
export BASTION_HOST_PRIVATE_IP="$2"
export NAT_GATEWAY_PRIVATE_IP="$3"
export VIRTUAL_NETWORK_GATEWAY="$4"
export TABLE_NAME='lockdown_private_instances'
export CONFIG_PATH='/etc/sysconfig/nftables.conf'

# Podman default network subnet (check with: podman network inspect podman)
export PODMAN_NETWORK_SUBNET="10.89.0.0/16"

if [[ -z "$1" ]] || [[ -z "$2" ]] || [[ -z "$3" ]] || [[ -z "$4" ]]; then
    echo "Error: Missing required parameters."
    echo "Usage: $0 <LOADBALANCER_PRIVATE_IP> <BASTION_HOST_PRIVATE_IP> <NAT_GATEWAY_PRIVATE_IP> <VIRTUAL_NETWORK_GATEWAY>"
    exit 1
fi

if [[ "$5" ]]; then
    echo "Allowing additional port for demo instance: $5"
    export LB_INGRESS_PORTS="{80,443,$5}"
else
    export LB_INGRESS_PORTS="{80,443}"
fi

### INSTALLATION ###
sudo dnf install --quiet -y nftables
printf "\n# network filter tables installed binary path:\n"
which nft

### CONFIGURATION ###

cat << EOF > $CONFIG_PATH
#!/usr/sbin/nft -f

# Delete previous table
table ip $TABLE_NAME
delete table ip $TABLE_NAME

# Create new IPv4 table
table ip $TABLE_NAME {

    # Filter ingress traffic
    chain input {

        # Drop all ingress for all protocols by default unless explicitly allowed
        type filter hook input priority 0; policy drop;

        # Allow loopback to localhost for internal services
        iif lo accept

        # Allow established and related connections
        ct state established,related accept

        # Allow SSH Ingress from Bastion Host
        ip saddr $BASTION_HOST_PRIVATE_IP tcp dport 22 ct state new accept

        # Allow HTTPS Ingress from Loadbalancer
        ip saddr $LOADBALANCER_PRIVATE_IP tcp dport $LB_INGRESS_PORTS ct state new accept

        # Allow ICMP Ping Ingress from Loadbalancer
        ip saddr $LOADBALANCER_PRIVATE_IP icmp type echo-request accept

        # Allow Podman container traffic to host (for port-mapped services)
        ip saddr $PODMAN_NETWORK_SUBNET accept
    }

    # Allow outbound http, https, dns, icmp
    chain output {
        # Drop all egress by default unless explicitly allowed
        type filter hook output priority 0; policy drop;

        # Allow Loopback
        oif lo accept

        # Allow established and related connections
        ct state established,related accept

        # Allow DNS queries to Hetzner DNS Servers and the Fallback DNS Server
        ip daddr {185.12.64.2, 185.12.64.1, 8.8.8.8} udp dport 53 ct state new accept

        # Allow ICMP to internet
        icmp type echo-request accept

        # Allow HTTP, HTTPS to internet
        tcp dport {80,443} ct state new accept

        # Allow traffic to Podman containers
        ip daddr $PODMAN_NETWORK_SUBNET accept
    }

    # Allow Podman container-to-container and port-forwarding traffic
    chain forward {
        type filter hook forward priority 0; policy drop;

        # Allow established and related connections
        ct state established,related accept

        # Allow traffic between Podman containers (same network)
        ip saddr $PODMAN_NETWORK_SUBNET ip daddr $PODMAN_NETWORK_SUBNET accept

        # Allow incoming traffic to be forwarded to containers (port mapping)
        ip daddr $PODMAN_NETWORK_SUBNET ct state new accept

        # Allow container responses back out
        ip saddr $PODMAN_NETWORK_SUBNET ct state new accept
    }
}
EOF

# ...existing code...
````

### More Restrictive Alternative (Interface-Based)

If you want tighter control using interface names instead of subnets:

````bash
# ...existing code...

cat << EOF > $CONFIG_PATH
#!/usr/sbin/nft -f

table ip $TABLE_NAME
delete table ip $TABLE_NAME

table ip $TABLE_NAME {

    chain input {
        type filter hook input priority 0; policy drop;

        iif lo accept
        ct state established,related accept

        ip saddr $BASTION_HOST_PRIVATE_IP tcp dport 22 ct state new accept
        ip saddr $LOADBALANCER_PRIVATE_IP tcp dport $LB_INGRESS_PORTS ct state new accept
        ip saddr $LOADBALANCER_PRIVATE_IP icmp type echo-request accept

        # Allow traffic from any podman interface
        iifname "podman*" accept
    }

    chain output {
        type filter hook output priority 0; policy drop;

        oif lo accept
        ct state established,related accept

        ip daddr {185.12.64.2, 185.12.64.1, 8.8.8.8} udp dport 53 ct state new accept
        icmp type echo-request accept
        tcp dport {80,443} ct state new accept

        # Allow traffic to any podman interface
        oifname "podman*" accept
    }

    chain forward {
        type filter hook forward priority 0; policy drop;

        ct state established,related accept

        # Allow forwarding between podman interfaces (container-to-container)
        iifname "podman*" oifname "podman*" accept

        # Allow external traffic to be forwarded to containers (port mapping ingress)
        oifname "podman*" ct state new accept

        # Allow container traffic to be forwarded out (container responses)
        iifname "podman*" ct state new accept
    }
}
EOF

# ...existing code...
````

## Summary of Changes

| Chain | Rule Added | Purpose |
|-------|------------|---------|
| `input` | `iifname "podman*" accept` | Allow container → host traffic |
| `output` | `oifname "podman*" accept` | Allow host → container traffic |
| `forward` | `iifname "podman*" oifname "podman*" accept` | Container-to-container (backend ↔ postgres) |
| `forward` | `oifname "podman*" ct state new accept` | External ingress via port mapping |
| `forward` | `iifname "podman*" ct state new accept` | Container response traffic |

This allows:
- ✅ Backend → PostgreSQL communication via `fiscalismia-network`
- ✅ External loadbalancer → Frontend via port mapping (if you switch from `network_mode: host`)
- ✅ External loadbalancer → Backend:8443 via port mapping
- ❌ Containers cannot reach arbitrary external hosts (still locked down)



######################################
######################################
######################################
######################################
######################################


                    -c[olor]}
[root@Fiscalismia-Demo ~]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: enp7s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc fq_codel state UP group default qlen 1000
    link/ether 86:00:00:8b:1e:cb brd ff:ff:ff:ff:ff:ff
    altname enx8600008b1ecb
    inet 172.20.0.2/32 brd 172.20.0.2 scope global dynamic enp7s0
       valid_lft 81469sec preferred_lft 81469sec
    inet6 fe80::8400:ff:fe8b:1ecb/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
4219: podman2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default qlen 1000
    link/ether 7a:0c:4e:80:5c:99 brd ff:ff:ff:ff:ff:ff
    inet 10.89.1.1/24 brd 10.89.1.255 scope global podman2
       valid_lft forever preferred_lft forever
    inet6 fe80::780c:4eff:fe80:5c99/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
4220: veth0@if2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master podman2 state UP group default qlen 1000
    link/ether a6:24:05:b0:5c:dc brd ff:ff:ff:ff:ff:ff link-netns netns-be1739b3-3a8d-1e30-04d5-66b8133cd6c0
    inet6 fe80::a424:5ff:feb0:5cdc/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
[root@Fiscalismia-Demo ~]# ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp7s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 86:00:00:8b:1e:cb brd ff:ff:ff:ff:ff:ff
    altname enx8600008b1ecb
4219: podman2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000
    link/ether 7a:0c:4e:80:5c:99 brd ff:ff:ff:ff:ff:ff
4220: veth0@if2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master podman2 state UP mode DEFAULT group default qlen 1000
    link/ether a6:24:05:b0:5c:dc brd ff:ff:ff:ff:ff:ff link-netns netns-be1739b3-3a8d-1e30-04d5-66b8133cd6c0
[root@Fiscalismia-Demo ~]# podman network ls
NETWORK ID    NAME                      DRIVER
33bbfee3eb2f  fiscalismia-demo_default  bridge
6cad27ada50c  fiscalismia-network       bridge
2f259bab93aa  podman                    bridge
[root@Fiscalismia-Demo ~]# podman network ls
NETWORK ID    NAME                      DRIVER
33bbfee3eb2f  fiscalismia-demo_default  bridge
6cad27ada50c  fiscalismia-network       bridge
2f259bab93aa  podman                    bridge
[root@Fiscalismia-Demo ~]# podman network inspect podman
[
     {
          "name": "podman",
          "id": "2f259bab93aaaaa2542ba43ef33eb990d0999ee1b9924b557b7be53c0b7a1bb9",
          "driver": "bridge",
          "network_interface": "podman0",
          "created": "2025-12-17T08:30:50.671932818Z",
          "subnets": [
               {
                    "subnet": "10.88.0.0/16",
                    "gateway": "10.88.0.1"
               }
          ],
          "ipv6_enabled": false,
          "internal": false,
          "dns_enabled": false,
          "ipam_options": {
               "driver": "host-local"
          },
          "containers": {}
     }
]
[root@Fiscalismia-Demo ~]# podman network inspect fiscalismia-demo_default
[
     {
          "name": "fiscalismia-demo_default",
          "id": "33bbfee3eb2f1cb182eb7ebe1be727559acf03a53379eab62bbba60275484860",
          "driver": "bridge",
          "network_interface": "podman1",
          "created": "2025-12-16T18:45:30.081650886Z",
          "subnets": [
               {
                    "subnet": "10.89.0.0/24",
                    "gateway": "10.89.0.1"
               }
          ],
          "ipv6_enabled": false,
          "internal": false,
          "dns_enabled": true,
          "labels": {
               "com.docker.compose.config-hash": "958447f5ace2b9cad8ad6178177e1373fad3a40fd1bef233c68fb5da92aa174c",
               "com.docker.compose.network": "default",
               "com.docker.compose.project": "fiscalismia-demo",
               "com.docker.compose.version": "5.0.0"
          },
          "options": {
               "isolate": "true"
          },
          "ipam_options": {
               "driver": "host-local"
          },
          "containers": {}
     }
]
[root@Fiscalismia-Demo ~]# podman network inspect fiscalismia-network
[
     {
          "name": "fiscalismia-network",
          "id": "6cad27ada50cf7b3570e59b3c2e19fc9893ca7fde7e906b23303ac33590c34a9",
          "driver": "bridge",
          "network_interface": "podman2",
          "created": "2025-12-16T18:57:50.762394098Z",
          "subnets": [
               {
                    "subnet": "10.89.1.0/24",
                    "gateway": "10.89.1.1"
               }
          ],
          "ipv6_enabled": false,
          "internal": false,
          "dns_enabled": true,
          "labels": {
               "com.docker.compose.config-hash": "5200a4b342c6d0f1f87d2ae89a94eb8fb14b223b4d199431e6feaeed301f21db",
               "com.docker.compose.network": "fiscalismia-network",
               "com.docker.compose.project": "fiscalismia-demo",
               "com.docker.compose.version": "5.0.0"
          },
          "options": {
               "isolate": "true"
          },
          "ipam_options": {
               "driver": "host-local"
          },
          "containers": {
               "6f59cb2b77f9e0d31d044357c68410cd5fb90a51f5fe11a79d8799e7247ef09e": {
                    "name": "fiscalismia-postgres",
                    "interfaces": {
                         "eth0": {
                              "subnets": [
                                   {
                                        "ipnet": "10.89.1.8/24",
                                        "gateway": "10.89.1.1"
                                   }
                              ],
                              "mac_address": "9e:86:ce:61:54:47"
                         }
                    }
               }
          }
     }
]
[root@Fiscalismia-Demo ~]# nmcli device
DEVICE   TYPE      STATE                   CONNECTION 
podman2  bridge    connected (externally)  podman2    
lo       loopback  connected (externally)  lo         
enp7s0   ethernet  unmanaged               --         
veth0    ethernet  unmanaged               --         
[root@Fiscalismia-Demo ~]# nft list ruleset
table ip lockdown_private_instances {
	chain input {
		type filter hook input priority filter; policy drop;
		iif "lo" accept
		ct state established,related accept
		ip saddr 172.20.1.2 tcp dport 22 ct state new accept
		ip saddr 172.20.1.3 tcp dport { 80, 443, 8443 } ct state new accept
		ip saddr 172.20.1.3 icmp type echo-request accept
	}

	chain output {
		type filter hook output priority filter; policy drop;
		oif "lo" accept
		ct state established,related accept
		ip daddr { 8.8.8.8, 185.12.64.1, 185.12.64.2 } udp dport 53 ct state new accept
		icmp type echo-request accept
		tcp dport { 80, 443 } ct state new accept
	}

	chain forward {
		type filter hook forward priority filter; policy drop;
	}
}
table inet netavark {
	chain INPUT {
		type filter hook input priority filter; policy accept;
		ip saddr 10.89.1.0/24 meta l4proto { tcp, udp } th dport 53 accept
	}

	chain FORWARD {
		type filter hook forward priority filter; policy accept;
		ct state invalid drop
		jump NETAVARK-ISOLATION-1
		ip daddr 10.89.1.0/24 ct state established,related accept
		ip saddr 10.89.1.0/24 accept
	}

	chain POSTROUTING {
		type nat hook postrouting priority srcnat; policy accept;
		meta mark & 0x00002000 == 0x00002000 masquerade
		ip saddr 10.89.1.0/24 jump nv_6cad27ad_10_89_1_0_nm24
	}

	chain PREROUTING {
		type nat hook prerouting priority dstnat; policy accept;
		fib daddr type local jump NETAVARK-HOSTPORT-DNAT
	}

	chain OUTPUT {
		type nat hook output priority dstnat; policy accept;
		fib daddr type local jump NETAVARK-HOSTPORT-DNAT
	}

	chain NETAVARK-HOSTPORT-DNAT {
	}

	chain NETAVARK-HOSTPORT-SETMARK {
		meta mark set meta mark | 0x00002000
	}

	chain NETAVARK-ISOLATION-1 {
		iifname "podman2" oifname != "podman2" jump NETAVARK-ISOLATION-2
	}

	chain NETAVARK-ISOLATION-2 {
		oifname "podman2" drop
	}

	chain NETAVARK-ISOLATION-3 {
		jump NETAVARK-ISOLATION-2
	}

	chain nv_6cad27ad_10_89_1_0_nm24 {
		ip daddr 10.89.1.0/24 accept
		ip daddr != 224.0.0.0/4 masquerade
	}
}
[root@Fiscalismia-Demo ~]# 

