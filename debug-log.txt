## Debugging Port Mapping Issue

If HAProxy is external and hitting `host-ip:443`, port mapping `443:443` should work. Let's diagnose:

**Step 1: Verify port is listening on host**

```bash
# On the demo instance
ss -tlnp | grep 443
# or
netstat -tlnp | grep 443
```

**Step 2: Check Docker port mapping**

```bash
docker ps --format "table {{.Names}}\t{{.Ports}}"
# Should show: 0.0.0.0:443->443/tcp
```

**Step 3: Test locally on the instance**

```bash
# From the demo instance itself
curl -k https://localhost:443 -v
```

**Step 4: Check firewall**

```bash
# Check if firewall allows 443
sudo iptables -L -n | grep 443
# or on firewalld systems
sudo firewall-cmd --list-ports
```

## Common Causes

| Issue | Check | Fix |
|-------|-------|-----|
| Port bound to 127.0.0.1 only | `ss -tlnp` shows `127.0.0.1:443` | Use `ports: "0.0.0.0:443:443"` |
| Firewall blocking | `iptables -L` | `sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT` |
| Docker iptables disabled | `dockerd` config | Enable iptables in Docker daemon |
| SELinux blocking | `ausearch -m avc` | Check SELinux denials |
| Container not actually listening | `docker logs` | Check nginx started correctly |

**Step 5: Check if nginx is actually listening inside container**

```bash
docker exec fiscalismia-frontend ss -tlnp
# Should show nginx listening on 443
```

What does `ss -tlnp | grep 443` show on your demo instance when using port mapping?


debug log:

[root@Fiscalismia-Demo ~]# podman ps
CONTAINER ID  IMAGE                                                 COMMAND               CREATED         STATUS                   PORTS                           NAMES
6f59cb2b77f9  docker.io/library/fiscalismia-postgres:1.0.0          -p 5432               22 minutes ago  Up 17 seconds (healthy)  5432/tcp                        fiscalismia-postgres
4743724fa4ed  ghcr.io/fiscalismia/fiscalismia-frontend-demo:latest  nginx -g daemon o...  2 minutes ago   Up 17 seconds            0.0.0.0:443->443/tcp, 8080/tcp  fiscalismia-frontend
[root@Fiscalismia-Demo ~]# podman exec -it fiscalismia-frontend sh
/etc/nginx $ netstat -ltnp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      1/nginx: master pro
/etc/nginx $ 

[root@Fiscalismia-Demo ~]# nft list ruleset
table ip lockdown_private_instances {
	chain input {
		type filter hook input priority filter; policy drop;
		iif "lo" accept
		ct state established,related accept
		ip saddr 172.20.1.2 tcp dport 22 ct state new accept
		ip saddr 172.20.1.3 tcp dport { 80, 443, 8443 } ct state new accept
		ip saddr 172.20.1.3 icmp type echo-request accept
	}

	chain output {
		type filter hook output priority filter; policy drop;
		oif "lo" accept
		ct state established,related accept
		ip daddr { 8.8.8.8, 185.12.64.1, 185.12.64.2 } udp dport 53 ct state new accept
		icmp type echo-request accept
		tcp dport { 80, 443 } ct state new accept
	}

	chain forward {
		type filter hook forward priority filter; policy drop;
	}
}



loadbalancer ingress remote:
[root@Fiscalismia-LoadBalancer ~]# curl -k 172.20.0.2:443 -v
*   Trying 172.20.0.2:443...
Timeout

[root@Fiscalismia-LoadBalancer ~]# nc -v4z 172.20.0.2 443
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: TIMEOUT


But when I switch to network_mode:host it works, see the debug log:
[root@Fiscalismia-Demo ~]# podman ps
CONTAINER ID  IMAGE                                                 COMMAND               CREATED         STATUS                   PORTS              NAMES
6f59cb2b77f9  docker.io/library/fiscalismia-postgres:1.0.0          -p 5432               28 minutes ago  Up 4 seconds (starting)  5432/tcp           fiscalismia-postgres
90f877aa4d63  ghcr.io/fiscalismia/fiscalismia-frontend-demo:latest  nginx -g daemon o...  4 seconds ago   Up 4 seconds             443/tcp, 8080/tcp  fiscalismia-frontend
[root@Fiscalismia-Demo ~]# podman exec -it fiscalismia-frontend sh
/etc/nginx $ netstat -ltnp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      1/nginx: master pro
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.54:53           0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:5355            0.0.0.0:*               LISTEN      -
tcp        0      0 10.89.1.1:53            0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -
tcp        0      0 :::22                   :::*                    LISTEN      -
tcp        0      0 :::5355                 :::*                    LISTEN      -
/etc/nginx $ 

[root@Fiscalismia-LoadBalancer ~]# nc -v4z 172.20.0.2 443
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Connected to 172.20.0.2:443.
Ncat: 0 bytes sent, 0 bytes received in 0.03 seconds.


[root@Fiscalismia-LoadBalancer ~]# curl -k 172.20.0.2:443 -v
*   Trying 172.20.0.2:443...
* Connected to 172.20.0.2 (172.20.0.2) port 443
* using HTTP/1.x
> GET / HTTP/1.1
> Host: 172.20.0.2:443
> User-Agent: curl/8.11.1
> Accept: */*
> 
* Request completely sent off
* Recv failure: Connection reset by peer
* closing connection #0
curl: (56) Recv failure: Connection reset by peer
