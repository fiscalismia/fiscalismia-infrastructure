name: Fiscalismia-Infrastructure Terraform Pipeline

on:
  push:
    branches:
      - main
      - pipeline_testing
  pull_request:
    branches:
      - main
      - pipeline_testing

jobs:
  #          __        __        __      __   ___  __        __             ___      ___
  #    |__| /  ` |    /  \ |  | |  \    |  \ |__  |__) |    /  \ \ /  |\/| |__  |\ |  |
  #    |  | \__, |___ \__/ \__/ |__/    |__/ |___ |    |___ \__/  |   |  | |___ | \|  |
  terraform-plan-hcloud:
    runs-on: ubuntu-latest

    permissions:
      id-token: write # for aws OIDC STS tokens to work
      contents: read
      actions: read

    steps:
    - name: Checkout SCM
      uses: actions/checkout@v5

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3.1.2

    - name: Configure AWS Credentials with OIDC JWT Token for STS Access to Hcloud Backend Role
      uses: aws-actions/configure-aws-credentials@v5.1.0
      with:
        role-to-assume: arn:aws:iam::010928217051:role/OpenID_Connect_GithubActions_TerraformHcloudBackendAccess
        role-session-name: TerraformPlanHcloud_STSSession
        aws-region: ${{ vars.AWS_REGION }}

    - name: Create Planfiles directory for artifacts
      run: mkdir -p ${GITHUB_WORKSPACE}/planfiles

    - name: Query SSH public keys for Hcloud servers from AWS Secrets Manager
      env:
        MASTER_PUBLIC_KEY: fiscalismia-infrastructure-master-key-hcloud.pub
        PRODUCTION_PUBLIC_KEY: fiscalismia-production-instances-key-hcloud.pub
        DEMO_PUBLIC_KEY: fiscalismia-demo-instance-key-hcloud.pub
      run: |
        mkdir -p ~/.ssh/
        echo "Querying ${MASTER_PUBLIC_KEY} from AWS"
        aws secretsmanager get-secret-value \
          --secret-id ${MASTER_PUBLIC_KEY} \
          --output text \
          --query SecretString | jq --raw-output '.public_key' \
          >> ~/.ssh/${MASTER_PUBLIC_KEY}
        echo "Querying ${PRODUCTION_PUBLIC_KEY} from AWS"
        aws secretsmanager get-secret-value \
          --secret-id ${PRODUCTION_PUBLIC_KEY} \
          --output text \
          --query SecretString | jq --raw-output '.public_key' \
          >> ~/.ssh/${PRODUCTION_PUBLIC_KEY}
        echo "Querying ${DEMO_PUBLIC_KEY} from AWS"
        aws secretsmanager get-secret-value \
          --secret-id ${DEMO_PUBLIC_KEY} \
          --output text \
          --query SecretString | jq --raw-output '.public_key' \
          >> ~/.ssh/${DEMO_PUBLIC_KEY}

        mkdir -p ${GITHUB_WORKSPACE}/ssh_public_keys
        cd ~/.ssh/
        ls -l
        cp -r ./*hcloud.pub ${GITHUB_WORKSPACE}/ssh_public_keys/

    - name: Generate terraform planfile for Hetzner Cloud
      env:
        HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
      run: |
        aws sts get-caller-identity

        cd ${GITHUB_WORKSPACE}/terraform/hetzner-cloud
        if ! [ -z "${HCLOUD_TOKEN}" ]; then echo hcloud token defined; else echo "hcloud token not defined"; fi
        terraform init
        terraform plan \
          -out ${GITHUB_WORKSPACE}/planfiles/hcloud.plan

    - name: Upload Planfile Artifacts
      uses: actions/upload-artifact@v5.0.0
      with:
        name: hcloud-planfile
        retention-days: 1
        path: |
          planfiles/hcloud*

    - name: Upload Hcloud Public Keys for Apply Step
      uses: actions/upload-artifact@v5.0.0
      with:
        name: public-hcloud-keys
        retention-days: 1
        path: |
          ssh_public_keys/*hcloud.pub

  terraform-review-hcloud:
    needs:
      - terraform-plan-hcloud

    runs-on: ubuntu-latest

    permissions:
      id-token: write # for aws OIDC STS tokens to work
      contents: read
      actions: read

    steps:
    - name: Checkout SCM
      uses: actions/checkout@v5

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3.1.2

    - name: Configure AWS Credentials with OIDC JWT Token for STS Access to Hcloud Backend Role
      uses: aws-actions/configure-aws-credentials@v5.1.0
      with:
        role-to-assume: arn:aws:iam::010928217051:role/OpenID_Connect_GithubActions_TerraformHcloudBackendAccess
        role-session-name: TerraformReviewHcloud_STSSession
        aws-region: ${{ vars.AWS_REGION }}

    - name: Download Planfile Artifacts
      uses: actions/download-artifact@v4
      with:
        name: hcloud-planfile
        path: planfiles/

    - name: Review Hcloud planfile
      env:
        HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
      run: |
        aws sts get-caller-identity
        cd ${GITHUB_WORKSPACE}/terraform/hetzner-cloud
        terraform init
        terraform show ${GITHUB_WORKSPACE}/planfiles/hcloud.plan


  terraform-apply-hcloud:
    environment: prod # requires manual approval before running
    timeout-minutes: 240 # Cancels the job if it isn't approved within 4 hours
    needs:
      - terraform-review-hcloud

    runs-on: ubuntu-latest

    permissions:
      id-token: write # for aws OIDC STS tokens to work
      contents: read
      actions: read

    steps:
    - name: Checkout SCM
      uses: actions/checkout@v5

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3.1.2

    - name: Configure AWS Credentials with OIDC JWT Token for STS Access to Hcloud Backend Role
      uses: aws-actions/configure-aws-credentials@v5.1.0
      with:
        role-to-assume: arn:aws:iam::010928217051:role/OpenID_Connect_GithubActions_TerraformHcloudBackendAccess
        role-session-name: TerraformApplyHcloud_STSSession
        aws-region: ${{ vars.AWS_REGION }}

    - name: Download Hcloud Planfile Artifact
      uses: actions/download-artifact@v4
      with:
        name: hcloud-planfile
        path: planfiles/

    - name: Download Hcloud Public SSH Key Artifacts
      uses: actions/download-artifact@v4
      with:
        name: public-hcloud-keys
        path: ~/.ssh/

    - name: Automatically apply hetzner cloud planfile
      env:
        HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
      run: |
        aws sts get-caller-identity

        ls -l ~/.ssh/
        cd ${GITHUB_WORKSPACE}/terraform/hetzner-cloud
        terraform init
        terraform apply --auto-approve ${GITHUB_WORKSPACE}/planfiles/hcloud.plan

  #               __      __   ___  __        __             ___      ___
  #     /\  |  | /__`    |  \ |__  |__) |    /  \ \ /  |\/| |__  |\ |  |
  #    /~~\ |/\| .__/    |__/ |___ |    |___ \__/  |   |  | |___ | \|  |
  terraform-plan-aws:
    runs-on: ubuntu-latest

    permissions:
      id-token: write # for aws OIDC STS tokens to work
      contents: read
      actions: read

    steps:
    - name: Checkout SCM
      uses: actions/checkout@v5

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3.1.2

    - name: Configure AWS Credentials with OIDC JWT Token for STS Access to Terraform Pipeline Role
      uses: aws-actions/configure-aws-credentials@v5.1.0
      with:
        role-to-assume: arn:aws:iam::010928217051:role/OpenID_Connect_GithubActions_TerraformPipeline
        role-session-name: TerraformPlanAWS_STSSession
        aws-region: ${{ vars.AWS_REGION }}

    - name: Create Planfiles directory for artifacts
      run: mkdir -p ${GITHUB_WORKSPACE}/planfiles

    - name: Generate terraform planfile for dynamic AWS resources
      run: |
        aws sts get-caller-identity

        cd ${GITHUB_WORKSPACE}/terraform/aws
        terraform init
        terraform plan \
          -var='secret_api_key=${{ secrets.API_GATEWAY_SECRET_KEY }}' \
          -var='test_sheet_url=${{ secrets.GOOGLE_DOCS_TEST_URL }}' \
          -var='forecasted_budget_notification_email=${{ secrets.BUDGET_NOTIFICATION_EMAIL }}' \
          -target=module.route_53_dns \
          -target=module.api_gateway \
          -target=module.lambda_image_processing \
          -target=module.lambda_raw_data_etl \
          -target=module.infrastructure_lambdas \
          -target=module.cost_budget_alarms \
          -target=module.sns_topics \
          -target=module.cloudwatch_metric_alarms \
          -out ${GITHUB_WORKSPACE}/planfiles/aws.plan

    - name: Upload AWS Planfile Artifact
      uses: actions/upload-artifact@v5.0.0
      with:
        name: aws-planfile
        retention-days: 1
        path: |
          planfiles/aws*

  terraform-review-aws:
    needs:
      - terraform-plan-aws

    runs-on: ubuntu-latest

    permissions:
      id-token: write # for aws OIDC STS tokens to work
      contents: read
      actions: read

    steps:
    - name: Checkout SCM
      uses: actions/checkout@v5

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3.1.2

    - name: Configure AWS Credentials with OIDC JWT Token for STS Access to Terraform Pipeline Role
      uses: aws-actions/configure-aws-credentials@v5.1.0
      with:
        role-to-assume: arn:aws:iam::010928217051:role/OpenID_Connect_GithubActions_TerraformPipeline
        role-session-name: TerraformReviewAWS_STSSession
        aws-region: ${{ vars.AWS_REGION }}

    - name: Download Planfile Artifacts
      uses: actions/download-artifact@v4
      with:
        name: aws-planfile
        path: planfiles/

    - name: Review AWS planfile
      run: |
        aws sts get-caller-identity

        cd ${GITHUB_WORKSPACE}/terraform/aws
        terraform init
        terraform show ${GITHUB_WORKSPACE}/planfiles/aws.plan
