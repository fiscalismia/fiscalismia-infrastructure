name: Webservice Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      deploy_demo:
        description: 'Deploy DEMO Backend & Frontend & local DB'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Deploy BACKEND on Production Instance?'
        required: false
        default: false
        type: boolean
      deploy_frontend:
        description: 'Deploy FRONTEND on Production Instance?'
        required: false
        default: false
        type: boolean

jobs:
  webservice-deployment:
    runs-on: ubuntu-latest

    permissions:
      id-token: write # for aws OIDC STS tokens to work
      contents: read
      actions: read

    steps:

    - name: Checkout Fiscalismia-Infrastructure Repository
      uses: actions/checkout@v5
      # https://github.com/actions/checkout
      with:
        path: fiscalismia-infrastructure

    - name: Checkout Fiscalismia-Frontend Repository
      uses: actions/checkout@v5
      # https://github.com/actions/checkout
      with:
        repository: fiscalismia/fiscalismia-frontend
        path: fiscalismia-frontend

    - name: Checkout Fiscalismia-Backend Repository
      uses: actions/checkout@v5
      # https://github.com/actions/checkout
      with:
        repository: fiscalismia/fiscalismia-backend
        path: fiscalismia-backend

    - name: Configure AWS Credentials with OIDC JWT Token for STS Access to Hcloud Backend Role
      uses: aws-actions/configure-aws-credentials@v5.1.1
      # https://github.com/aws-actions/configure-aws-credentials
      with:
        role-to-assume: arn:aws:iam::010928217051:role/OpenID_Connect_GithubActions_TerraformHcloudBackendAccess
        role-session-name: HcloudWebserviceDeployment_STSSession
        aws-region: ${{ vars.AWS_REGION }}

    - name: Query SSH private keys for Hcloud servers from AWS Secrets Manager
      env:
        MASTER_PRIVATE_KEY: fiscalismia-infrastructure-master-key-hcloud
        DEMO_PRIVATE_KEY: fiscalismia-demo-instance-key-hcloud
        PRODUCTION_PRIVATE_KEY: fiscalismia-production-instances-key-hcloud
      run: |
        set -eou pipefail
        mkdir -p ~/.ssh/

        echo "Starting ssh-agent and exporting environment variables"
        eval "$(ssh-agent -s)"
        echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
        echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV

        query_aws_plaintext_secret() {
          echo "Querying $1 from AWS"
          aws secretsmanager get-secret-value \
            --secret-id $1 \
            --output text \
            --query SecretString \
            | ssh-add - > /dev/null 2>&1
        }

        query_aws_plaintext_secret ${MASTER_PRIVATE_KEY}
        query_aws_plaintext_secret ${DEMO_PRIVATE_KEY}
        query_aws_plaintext_secret ${PRODUCTION_PRIVATE_KEY}

    - name: Extract Hcloud Server IP Adresses from Remote State
      env:
        S3_BUCKET: hangrybear-tf-backend-state-bucket
        S3_PREFIX: fiscalismia-infrastructure/hcloud
        S3_KEY: state.tfstate
      run : |
        aws s3 cp s3://${S3_BUCKET}/${S3_PREFIX}/${S3_KEY} .

        bastion_ip=$(cat state.tfstate | jq -r .outputs.fiscalismia_bastion_host_ipv4.value )
        demo_ip=$(cat state.tfstate | jq -r .outputs.fiscalismia_demo_private_ipv4.value )
        front_ip=$(cat state.tfstate | jq -r .outputs.fiscalismia_frontend_private_ipv4.value )
        back_ip=$(cat state.tfstate | jq -r .outputs.fiscalismia_backend_private_ipv4.value )

        echo "BASTION_HOST_PUBLIC_IP=$bastion_ip" >> $GITHUB_ENV
        echo "DEMO_INSTANCE_PRIVATE_IP=$demo_ip" >> $GITHUB_ENV
        echo "FRONTEND_INSTANCE_PRIVATE_IP=$front_ip" >> $GITHUB_ENV
        echo "BACKEND_INSTANCE_PRIVATE_IP=$back_ip" >> $GITHUB_ENV

    - name: Create SSH Config for Bastion-Host ProxyJump
      run: |
        cat << EOF > ~/.ssh/config
        Host bastion-host
            HostName $BASTION_HOST_PUBLIC_IP
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null

        Host demo
            HostName $DEMO_INSTANCE_PRIVATE_IP
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyJump bastion-host

        Host frontend
            HostName $FRONTEND_INSTANCE_PRIVATE_IP
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyJump bastion-host

        Host backend
            HostName $BACKEND_INSTANCE_PRIVATE_IP
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyJump bastion-host
        EOF

        chmod 600 ~/.ssh/config

    #     __   ___        __      __   ___  __        __             ___      ___
    #    |  \ |__   |\/| /  \    |  \ |__  |__) |    /  \ \ /  |\/| |__  |\ |  |
    #    |__/ |___  |  | \__/    |__/ |___ |    |___ \__/  |   |  | |___ | \|  |

    - name: Prepare DEMO Workspace
      if: inputs.deploy_demo == true
      env:
        REMOTE_DEMO_DIR: /usr/local/etc/fiscalismia-demo
      run: |
        echo "REMOTE_DEMO_DIR=$REMOTE_DEMO_DIR" >> $GITHUB_ENV
        echo "FRONTEND_DIR=${GITHUB_WORKSPACE}/fiscalismia-frontend" >> $GITHUB_ENV
        echo "BACKEND_DIR=${GITHUB_WORKSPACE}/fiscalismia-backend" >> $GITHUB_ENV
        echo "INFRA_DIR=${GITHUB_WORKSPACE}/fiscalismia-infrastructure" >> $GITHUB_ENV

    - name: Initialize DEMO Instance
      if: inputs.deploy_demo == true
      run: |
        ssh demo << EOF
        mkdir -p ${REMOTE_DEMO_DIR}
        mkdir -p ${REMOTE_DEMO_DIR}/database
        mkdir -p ${REMOTE_DEMO_DIR}/frontend
        mkdir -p ${REMOTE_DEMO_DIR}/backend
        mkdir -p ${REMOTE_DEMO_DIR}/certs

        # copy ssl certificates to deployment directory
        cp /etc/letsencrypt/live/demo.fiscalismia.com/fullchain.pem ${REMOTE_DEMO_DIR}/certs/
        cp /etc/letsencrypt/live/demo.fiscalismia.com/privkey.pem ${REMOTE_DEMO_DIR}/certs/
        # change cert ownership to read only by unpriviledged nginx userid and groupid
        chown -R 101:101 ${REMOTE_DEMO_DIR}/certs/
        chmod -R 400 ${REMOTE_DEMO_DIR}/certs/*.pem
        EOF

    - name: Secure Copy Dependencies to DEMO Instance
      if: inputs.deploy_demo == true
      env:
        ENV_FILE_SECRET_ID: fiscalismia-backend/.env
      run: |
        ### INFRA SETUP
        scp ${INFRA_DIR}/docker-compose.demo.instance.yml demo:${REMOTE_DEMO_DIR}/docker-compose.yml
        aws secretsmanager get-secret-value \
            --secret-id $ENV_FILE_SECRET_ID \
            --region eu-central-1 \
            --output text \
            --query SecretString \
            >> ${INFRA_DIR}/.env
        scp ${INFRA_DIR}/.env demo:${REMOTE_DEMO_DIR}/.env
        rm -f ${INFRA_DIR}/.env

        ### FRONTEND SETUP
        scp ${FRONTEND_DIR}/Dockerfile demo:${REMOTE_DEMO_DIR}/frontend/Dockerfile

        ### BACKEND SETUP
        scp ${BACKEND_DIR}/Dockerfile demo:${REMOTE_DEMO_DIR}/backend/Dockerfile

        ### DATABASE SETUP
        scp ${BACKEND_DIR}/database/Dockerfile demo:${REMOTE_DEMO_DIR}/database/Dockerfile
        scp \
          ${BACKEND_DIR}/database/pgsql-public-ddl.sql \
          ${BACKEND_DIR}/database/pgsql-user-ddl.sql \
          ${BACKEND_DIR}/database/pgsql-demo-dml.sql \
          ${BACKEND_DIR}/database/pgsql-local-initdb.sh \
          demo:${REMOTE_DEMO_DIR}/database/

    - name: Deploy on DEMO Instance via OpenSSH
      if: inputs.deploy_demo == true
      run: |
        ssh demo "ls -Rhla ${REMOTE_DEMO_DIR}/"
        ssh demo << EOF
          cd ${REMOTE_DEMO_DIR}
          docker compose up --build --detach --no-deps fiscalismia-postgres fiscalismia-frontend

        EOF
    #     __        __        ___       __      __   ___  __        __             ___      ___
    #    |__)  /\  /  ` |__/ |__  |\ | |  \    |  \ |__  |__) |    /  \ \ /  |\/| |__  |\ |  |
    #    |__) /~~\ \__, |  \ |___ | \| |__/    |__/ |___ |    |___ \__/  |   |  | |___ | \|  |

    - name: Deploy BACKEND Production Instance via OpenSSH
      if: inputs.deploy_backend == true
      run: |
        echo "Deploying on Backend Instance"

    #     ___  __   __       ___  ___       __      __   ___  __        __             ___      ___
    #    |__  |__) /  \ |\ |  |  |__  |\ | |  \    |  \ |__  |__) |    /  \ \ /  |\/| |__  |\ |  |
    #    |    |  \ \__/ | \|  |  |___ | \| |__/    |__/ |___ |    |___ \__/  |   |  | |___ | \|  |

    - name: Deploy FRONTEND Production Instance via OpenSSH
      if: inputs.deploy_frontend == true
      run: |
        echo "Deploying on Frontend Instance"