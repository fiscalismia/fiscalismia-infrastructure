name: Security-Evaluation HCLOUD

on:
  push:
    branches:
      - main
      - pipeline_testing
  pull_request:
    branches:
      - main
      - pipeline_testing

jobs:
  security-evaluate-hcloud:
    environment: prod # requires manual approval before running, as it requires hcloud servers to be up and running
    timeout-minutes: 240 # Cancels the job if it isn't approved within 4 hours
    runs-on: ubuntu-latest

    permissions:
      id-token: write # for aws OIDC STS tokens to work
      contents: read
      actions: read

    steps:

    - name: Checkout SCM
      uses: actions/checkout@v5

    - name: Configure AWS Credentials with OIDC JWT Token for STS Access to Hcloud Backend Role
      uses: aws-actions/configure-aws-credentials@v5.1.0
      with:
        role-to-assume: arn:aws:iam::010928217051:role/OpenID_Connect_GithubActions_TerraformHcloudBackendAccess
        role-session-name: HcloudSecurityEvaluation_STSSession
        aws-region: ${{ vars.AWS_REGION }}

    - name: Query SSH private keys for Hcloud servers from AWS Secrets Manager
      env:
        MASTER_PRIVATE_KEY: fiscalismia-infrastructure-master-key-hcloud
        LOADBALANCER_PRIVATE_KEY: fiscalismia-loadbalancer-instance-key-hcloud
        NAT_GATEWAY_PRIVATE_KEY: fiscalismia-nat-gateway-instance-key-hcloud
        MONITORING_PRIVATE_KEY: fiscalismia-monitoring-instance-key-hcloud
        DEMO_PRIVATE_KEY: fiscalismia-demo-instance-key-hcloud
        PRODUCTION_PRIVATE_KEY: fiscalismia-production-instances-key-hcloud
      run: |
        set -eou pipefail
        mkdir -p ~/.ssh/

        echo "Starting ssh-agent and exporting environment variables"
        eval "$(ssh-agent -s)"
        echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
        echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV

        query_aws_plaintext_secret() {
          echo "Querying $1 from AWS"
          aws secretsmanager get-secret-value \
            --secret-id $1 \
            --output text \
            --query SecretString \
            | ssh-add - > /dev/null 2>&1
        }

        query_aws_plaintext_secret ${MASTER_PRIVATE_KEY}
        query_aws_plaintext_secret ${LOADBALANCER_PRIVATE_KEY}
        query_aws_plaintext_secret ${NAT_GATEWAY_PRIVATE_KEY}
        query_aws_plaintext_secret ${MONITORING_PRIVATE_KEY}
        query_aws_plaintext_secret ${DEMO_PRIVATE_KEY}
        query_aws_plaintext_secret ${PRODUCTION_PRIVATE_KEY}

    - name: Extract Hcloud Server IP Adresses from Remote State
      env:
        S3_BUCKET: hangrybear-tf-backend-state-bucket
        S3_PREFIX: fiscalismia-infrastructure/hcloud
        S3_KEY: state.tfstate
      run : |
        aws s3 cp s3://${S3_BUCKET}/${S3_PREFIX}/${S3_KEY} .
        bastion_ip=$(cat state.tfstate | jq .outputs.fiscalismia_bastion_host_ipv4.value )
        demo_ip=$(cat state.tfstate | jq .outputs.fiscalismia_demo_private_ipv4.value )
        lb_ip=$(cat state.tfstate | jq .outputs.fiscalismia_loadbalancer_private_ipv4.value )
        nat_ip=$(cat state.tfstate | jq .outputs.fiscalismia_nat_gateway_private_ipv4.value )
        monitor_ip=$(cat state.tfstate | jq .outputs.fiscalismia_monitoring_private_ipv4.value )
        front_ip=$(cat state.tfstate | jq .outputs.fiscalismia_frontend_private_ipv4.value )
        back_ip=$(cat state.tfstate | jq .outputs.fiscalismia_backend_private_ipv4.value )

        echo "BASTION_HOST_PUBLIC_IP=$bastion_ip" >> $GITHUB_ENV
        echo "DEMO_INSTANCE_PRIVATE_IP=$demo_ip" >> $GITHUB_ENV
        echo "LOADBALANCER_PRIVATE_IP=$lb_ip" >> $GITHUB_ENV
        echo "NAT_GATEWAY_PRIVATE_IP=$nat_ip" >> $GITHUB_ENV
        echo "MONITORING_INSTANCE_PRIVATE_IP=$monitor_ip" >> $GITHUB_ENV
        echo "FRONTEND_INSTANCE_PRIVATE_IP=$front_ip" >> $GITHUB_ENV
        echo "BACKEND_INSTANCE_PRIVATE_IP=$back_ip" >> $GITHUB_ENV

    - name: Create SSH Config for Bastion-Host ProxyJump
      run: |
        cat << EOF > ~/.ssh/config
        Host bastion-host
            HostName $BASTION_HOST_PUBLIC_IP
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null

        Host demo
            HostName $DEMO_INSTANCE_PRIVATE_IP
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyJump bastion-host

        Host loadbalancer
            HostName $LOADBALANCER_PRIVATE_IP
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyJump bastion-host

        Host nat-gateway
            HostName $NAT_GATEWAY_PRIVATE_IP
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyJump bastion-host

        Host monitoring
            HostName $MONITORING_INSTANCE_PRIVATE_IP
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyJump bastion-host

        Host frontend
            HostName $FRONTEND_INSTANCE_PRIVATE_IP
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyJump bastion-host

        Host backend
            HostName $BACKEND_INSTANCE_PRIVATE_IP
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyJump bastion-host
        EOF

        chmod 600 ~/.ssh/config

    - name: Security Evaluation of Loadbalancer
      env:
        SCRIPT_NAME: evaluate_loadbalancer_firewall.sh
        SCRIPT_PATH: security/hcloud/
        NETWORK_YML: terraform/hetzner-cloud/config/network.private.ips.yml
        REMOTE_DIR: /root/security/
        REMOTE_LOG: /root/security_evaluation.log
      run: |
        echo "Parsing Network addresses..."
        TARGETS=$(yq '
          .ips.gateways | to_entries | .[] | "virtual_network_gateway_" + .key + "_net:" + .value,
          .ips.private_instances | to_entries | .[] | "fiscalismia_" + .key + "_private_ipv4:" + .value,
          (.ips.exposed_instances | to_entries | .[] | .key as $parent | .value | to_entries | .[] | "fiscalismia_" + $parent + "_private_ipv4_" + .key + "_net:" + .value)
        ' $NETWORK_YML | tr '\n' ' ')

        echo "Generated Targets: $TARGETS"

        ssh loadbalancer "mkdir -p $REMOTE_DIR"
        scp ${SCRIPT_PATH}${SCRIPT_NAME} loadbalancer:$REMOTE_DIR
        ssh loadbalancer "chmod u+x ${REMOTE_DIR}${SCRIPT_NAME}"
        REMOTE_COMMAND="${REMOTE_DIR}${SCRIPT_NAME} '$TARGETS' >> $REMOTE_LOG 2>&1"
        ssh loadbalancer "$REMOTE_COMMAND"
        ssh loadbalancer "cat $REMOTE_LOG"
